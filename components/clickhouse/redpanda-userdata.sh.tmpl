#!/usr/bin/env bash
set -euxo pipefail
exec > >(tee -a /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1
echo "[userdata-redpanda] start $(date -Is)"

# ---------------- Inputs from Terraform ----------------
EBS_DEV="${EBS_DEVICE}"                   # "" => auto-pick largest non-root NVMe
MNT="${MOUNT_POINT}"                      # e.g., "/var/lib/redpanda"
MARKER_FILE="${MARKER_FILE}"              # e.g., "/var/local/BOOTSTRAP_OK"
BACKUP_BUCKET="${BACKUP_BUCKET}"          # (unused here; safe)
BACKUP_PREFIX="${BACKUP_PREFIX}"          # (unused here; safe)
AWS_REGION="${AWS_REGION}"                # e.g., "us-east-1"

# Optional boot topic args (filled by templatefile; may be empty)
REDPANDA_BOOT_TOPIC="${REDPANDA_BOOT_TOPIC}"
REDPANDA_PARTITIONS="${REDPANDA_PARTITIONS}"
REDPANDA_RF="${REDPANDA_RF}"

# Exporter versions (overridable via TF)
NODE_EXPORTER_VERSION="${NODE_EXPORTER_VERSION}"

# ---------------- Wait for basic network ----------------
for i in {1..30}; do curl -fsS https://aws.amazon.com >/dev/null && break || sleep 2; done

# ---------------- Detect package manager / distro -------
PM=""
DISTRO=""
if command -v dnf >/dev/null 2>&1; then PM="dnf"; DISTRO="al2023"
elif command -v yum >/dev/null 2>&1; then PM="yum"; DISTRO="al2"
elif command -v apt-get >/dev/null 2>&1; then PM="apt"; DISTRO="ubuntu"
else echo "ERROR: No supported package manager found (dnf/yum/apt)" >&2; exit 1; fi

# ---------------- Install & start SSM -------------------
if [[ "$PM" == "apt" ]]; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y || true
  apt-get install -y amazon-ssm-agent || true
else
  $PM -y update || true
  $PM -y install amazon-ssm-agent || true
fi
systemctl enable --now amazon-ssm-agent
systemctl is-active --quiet amazon-ssm-agent

# ---------------- Core tools ----------------------------
if [[ "$PM" == "apt" ]]; then
  apt-get install -y ca-certificates jq rsync xfsprogs xz-utils curl awscli zstd gnupg netcat
else
  $PM -y install ca-certificates jq rsync xfsprogs dnf-plugins-core awscli zstd nmap-ncat --skip-broken || true
fi

# ---------------- Optional: pick & mount data disk -------
if [[ -n "$MNT" ]]; then
  mkdir -p "$MNT"

  pick_data_dev() {
    if [[ -n "$EBS_DEV" && -b "$EBS_DEV" ]]; then echo "$EBS_DEV"; return 0; fi
    local rootpk
    rootpk="$(lsblk -no pkname "$(findmnt -no SOURCE /)" 2>/dev/null | head -n1)"
    lsblk -dn -o NAME,TYPE,SIZE \
    | awk '$2=="disk"{print $1" "$3}' \
    | sort -k2 -hr | awk '{print $1}' \
      | while read -r n; do
          [[ "$n" == "$rootpk" ]] && continue
          [[ -b "/dev/$n" ]] && { echo "/dev/$n"; break; }
        done
  }

  DATA_DEV=""
  for _ in {1..60}; do
    DATA_DEV="$(pick_data_dev || true)"
    [[ -n "$DATA_DEV" && -b "$DATA_DEV" ]] && break
    sleep 2
  done

  if [[ -n "$DATA_DEV" ]]; then
    if ! blkid "$DATA_DEV" >/dev/null 2>&1; then
      if [[ "$PM" == "apt" ]]; then apt-get install -y xfsprogs; else $PM -y install xfsprogs || true; fi
      mkfs.xfs -f "$DATA_DEV"
    fi
    UUID="$(blkid -s UUID -o value "$DATA_DEV")"
    sed -i "\|[[:space:]]$MNT[[:space:]]|d;/^\/dev\/xvdb[[:space:]]/d" /etc/fstab
    grep -q "$UUID" /etc/fstab || echo "UUID=$UUID  $MNT  xfs  defaults,nofail  0  2" >> /etc/fstab
    mount -a
    mountpoint -q "$MNT"
  else
    echo "WARN: No data disk found; Redpanda will use default /var/lib/redpanda" >&2
  fi
fi

# ---------------- Install Redpanda (+rpk) ----------------
if [[ "$PM" == "apt" ]]; then
  curl -1sLf 'https://dl.redpanda.com/nzc4ZYQK3WRGd9sy/redpanda/cfg/setup/bash.deb.sh' | bash
  apt-get update -y
  apt-get install -y redpanda redpanda-rpk
else
  curl -1sLf 'https://dl.redpanda.com/nzc4ZYQK3WRGd9sy/redpanda/cfg/setup/bash.rpm.sh' | bash
  $PM -y install redpanda redpanda-rpk
fi

# ---------------- Layout & ownership --------------------
mkdir -p /var/lib/redpanda
if [[ -n "$MNT" && "$MNT" != "/var/lib/redpanda" && -d "$MNT" ]]; then
  rsync -aHAX --delete /var/lib/redpanda/ "$MNT"/ || true
  rm -rf /var/lib/redpanda
  ln -s "$MNT" /var/lib/redpanda
fi
mkdir -p /var/lib/redpanda/data
chown -R redpanda:redpanda /var/lib/redpanda || true

# ---------------- Static config (single node) ------------
PRIV_IP="$(hostname -I | awk '{print $1}')"
systemctl stop redpanda || true

cat >/etc/redpanda/redpanda.yaml <<EOF
config_file_version: 2
redpanda:
  node_id: 0
  data_directory: /var/lib/redpanda/data
  developer_mode: true
  auto_create_topics_enabled: true
  kafka_api:
    - address: 0.0.0.0
      port: 9092
  advertised_kafka_api:
    - address: $${PRIV_IP}
      port: 9092
  rpc_server:
    address: 0.0.0.0
    port: 33145
  advertised_rpc_api:
    address: $${PRIV_IP}
    port: 33145
  admin:
    - address: 0.0.0.0
      port: 9644
pandaproxy: {}
schema_registry: {}
rpk:
  overprovisioned: true
  enable_usage_stats: false
EOF

# ---------------- Start & wait ---------------------------
systemctl enable --now redpanda
for i in {1..60}; do ss -ltn | grep -q ':9092' && break || sleep 1; done
for i in {1..60}; do ss -ltn | grep -q ':9644' && break || sleep 1; done

# ---------------- Smoke test -----------------------------
rpk version || true
rpk cluster info || true

# Optional: create a boot topic
if [[ -n "$REDPANDA_BOOT_TOPIC" ]]; then
  rpk topic create "$REDPANDA_BOOT_TOPIC" -p "$REDPANDA_PARTITIONS" -r "$REDPANDA_RF" \
    --brokers "$${PRIV_IP}:9092" || true
fi

# ---------------- Exporters (node_exporter) --------------
# Arch detect for release assets
ARCH="amd64"
case "$(uname -m)" in
  x86_64) ARCH="amd64" ;;
  aarch64|arm64) ARCH="arm64" ;;
esac

install -d -m 0755 /usr/local/src/exporters
pushd /usr/local/src/exporters >/dev/null

NODE_TGZ="node_exporter-${NODE_EXPORTER_VERSION}.linux-$${ARCH}.tar.gz"
curl -fL -o "$NODE_TGZ" "https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXPORTER_VERSION}/$NODE_TGZ"
tar -xzf "$NODE_TGZ"
install -m 0755 "node_exporter-${NODE_EXPORTER_VERSION}.linux-$${ARCH}/node_exporter" /usr/local/bin/node_exporter
popd >/dev/null

# systemd: node_exporter on :9100
cat >/etc/systemd/system/node_exporter.service <<'EOF'
[Unit]
Description=Prometheus Node Exporter
After=network-online.target
Wants=network-online.target

[Service]
User=root
ExecStart=/usr/local/bin/node_exporter --web.listen-address=":9100"
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now node_exporter

# Sanity checks (non-fatal)
curl -fsS http://127.0.0.1:9100/metrics | head -n 5 || true
curl -fsS http://127.0.0.1:9644/metrics | head -n 5 || true

# ---------------- Marker -------------------------------
echo "$(date -u +%FT%TZ) BOOTSTRAP_OK" > "$MARKER_FILE"
echo "[userdata-redpanda] done $(date -Is)"
