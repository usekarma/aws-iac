#!/usr/bin/env bash
set -euxo pipefail
exec > >(tee -a /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1
echo "[userdata-mongo] start $(date -Is)"

# ---------------- Inputs from Terraform (bind once) ----
export EBS_DEV="${EBS_DEVICE}"                      # "" => auto-pick largest non-root NVMe
export MNT="${MOUNT_POINT}"                         # e.g., "/var/lib/mongo"
export MARKER_FILE="${MARKER_FILE}"                 # e.g., "/var/local/BOOTSTRAP_OK"
export CLICKHOUSE_BUCKET="${CLICKHOUSE_BUCKET}"     # e.g., "usekarma.dev-prod"
export CLICKHOUSE_PREFIX="${CLICKHOUSE_PREFIX}"     # e.g., "mongo"
export AWS_REGION="${AWS_REGION}"                   # e.g., "us-east-1"

export MONGO_MAJOR="${MONGO_MAJOR}"
export MONGO_PORT="${MONGO_PORT}"
export RS_NAME="${RS_NAME}"

export NODE_EXPORTER_VERSION="${NODE_EXPORTER_VERSION}"
export MONGODB_EXPORTER_VERSION="${MONGODB_EXPORTER_VERSION}"

# --- mongo-gen git install inputs (Terraform) ---
# NOTE: pass repo URL WITHOUT "https://", e.g. "github.com/usekarma/mongo-gen.git"
export MONGO_GEN_REPO_URL="${MONGO_GEN_REPO_URL}"
export MONGO_GEN_BRANCH="${MONGO_GEN_BRANCH}"
# SSM parameter name that holds a GitHub token (optional; for private repos)
export MONGO_GEN_TOKEN_PARAM="${MONGO_GEN_TOKEN_PARAM}"

# ---------------- Wait for basic network ----------------
for i in {1..60}; do
  curl -fsS https://aws.amazon.com >/dev/null && break || sleep 2
done

# ---------------- Install awscli + curl (just enough to fetch bootstrap) ---
if command -v apt-get >/dev/null 2>&1; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y || true
  apt-get install -y curl awscli ca-certificates || true
else
  if command -v dnf >/dev/null 2>&1; then PM=dnf
  else PM=yum
  fi
  $PM -y update || true
  $PM -y install curl awscli ca-certificates --skip-broken || true
fi

# ---------------- Fetch and run big bootstrap from S3 ----------------
BOOTSTRAP="/opt/bootstrap/mongo-bootstrap.sh"
install -d -m 0755 /opt/bootstrap

aws s3 cp \
  "s3://${CLICKHOUSE_BUCKET}/${CLICKHOUSE_PREFIX}/scripts/mongo-bootstrap.sh" \
  "$BOOTSTRAP" \
  --region "${AWS_REGION}"

chmod +x "$BOOTSTRAP"
exec "$BOOTSTRAP"
