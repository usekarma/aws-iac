#!/usr/bin/env bash
set -euxo pipefail
exec > >(tee -a /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1
echo "[userdata] start $(date -Is)"

# ---------------- Inputs from Terraform ----------------
EBS_DEV="${EBS_DEVICE}"                     # "" => auto-pick largest non-root NVMe
MNT="${MOUNT_POINT}"                        # e.g., "/var/lib/clickhouse"
MARKER_FILE="${MARKER_FILE}"                # e.g., "/var/local/BOOTSTRAP_OK"
CH_HTTP="${CH_HTTP_PORT}"                   # e.g., 8123
CH_TCP="${CH_TCP_PORT}"                     # e.g., 9000
BACKUP_BUCKET="${BACKUP_BUCKET}"            # e.g., "usekarma.dev-prod"
BACKUP_PREFIX="${BACKUP_PREFIX}"            # e.g., "clickhouse"
AWS_REGION="${AWS_REGION}"                  # e.g., "us-east-1"

# ---------------- Wait for basic network ----------------
for i in {1..30}; do curl -fsS https://aws.amazon.com >/dev/null && break || sleep 2; done

# ---------------- Detect package manager / distro -------
PM=""
if command -v dnf >/dev/null 2>&1; then
  PM="dnf" ; DISTRO="al2023"
elif command -v yum >/dev/null 2>&1; then
  PM="yum" ; DISTRO="al2"
elif command -v apt-get >/dev/null 2>&1; then
  PM="apt" ; DISTRO="ubuntu"
else
  echo "ERROR: No supported package manager found (dnf/yum/apt)" >&2
  exit 1
fi

# ---------------- Install & start SSM -------------------
if [[ "$PM" == "apt" ]]; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y
  apt-get install -y amazon-ssm-agent || true
else
  $PM -y update || true
  $PM -y install amazon-ssm-agent || true
fi
systemctl enable --now amazon-ssm-agent
systemctl is-active --quiet amazon-ssm-agent

# ---------------- Core tools ----------------------------
if [[ "$PM" == "apt" ]]; then
  apt-get install -y ca-certificates jq rsync xfsprogs xz-utils curl awscli zstd
else
  $PM -y install ca-certificates jq rsync xfsprogs dnf-plugins-core awscli zstd --skip-broken || true
fi

# ---------------- Optional: pick & mount data disk -------
if [[ -n "$MNT" ]]; then
  mkdir -p "$MNT"

  pick_data_dev() {
    if [[ -n "$EBS_DEV" && -b "$EBS_DEV" ]]; then echo "$EBS_DEV"; return 0; fi
    local rootpk
    rootpk="$(lsblk -no pkname "$(findmnt -no SOURCE /)" 2>/dev/null | head -n1)"
    lsblk -dn -o NAME,TYPE,SIZE \
    | awk '$2=="disk"{print $1" "$3}' \
    | sort -k2 -hr | awk '{print $1}' \
      | while read -r n; do
          [[ "$n" == "$rootpk" ]] && continue
          [[ -b "/dev/$n" ]] && { echo "/dev/$n"; break; }
        done
  }

  DATA_DEV=""
  for _ in {1..60}; do
    DATA_DEV="$(pick_data_dev || true)"
    [[ -n "$DATA_DEV" && -b "$DATA_DEV" ]] && break
    sleep 2
  done

  if [[ -n "$DATA_DEV" ]]; then
    if ! blkid "$DATA_DEV" >/dev/null 2>&1; then
      if [[ "$PM" == "apt" ]]; then apt-get install -y xfsprogs; else $PM -y install xfsprogs || true; fi
      mkfs.xfs -f "$DATA_DEV"
    fi
    UUID="$(blkid -s UUID -o value "$DATA_DEV")"
    # Remove stale lines for this mountpoint or legacy /dev/xvdb
    sed -i "\|[[:space:]]$MNT[[:space:]]|d;/^\/dev\/xvdb[[:space:]]/d" /etc/fstab
    grep -q "$UUID" /etc/fstab || echo "UUID=$UUID  $MNT  xfs  defaults,nofail  0  2" >> /etc/fstab
    mount -a
    mountpoint -q "$MNT"
  else
    echo "WARN: No data disk found; ClickHouse will use default /var/lib/clickhouse" >&2
  fi
fi

# ---------------- Install ClickHouse --------------------
if [[ "$PM" == "apt" ]]; then
  install -m 0755 -d /usr/share/keyrings
  curl -fsSL https://packages.clickhouse.com/apt/doc/apt-key.gpg \
    | gpg --dearmor -o /usr/share/keyrings/clickhouse.gpg
  echo "deb [signed-by=/usr/share/keyrings/clickhouse.gpg] https://packages.clickhouse.com/deb stable main" \
    > /etc/apt/sources.list.d/clickhouse.list
  apt-get update -y
  apt-get install -y clickhouse-server clickhouse-client
else
  # Official repo file contains correct baseurl & gpgkey
  dnf config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo || true
  $PM -y makecache || true
  $PM -y install clickhouse-server clickhouse-client
fi

# ---------------- Configure data path & ports -----------
systemctl stop clickhouse-server || true

TARGET_PATH="/var/lib/clickhouse"
if [[ -n "$MNT" && -n "$(mount | awk '{print $3}' | grep -Fx "$MNT" || true)" ]]; then
  TARGET_PATH="$MNT"
fi

mkdir -p "$TARGET_PATH" /var/lib/clickhouse
chown -R clickhouse:clickhouse "$TARGET_PATH"
rsync -a /var/lib/clickhouse/ "$TARGET_PATH"/ || true
chown -R clickhouse:clickhouse "$TARGET_PATH"

mkdir -p /etc/clickhouse-server/config.d

# Use unquoted heredocs so bash expands at runtime; $${...} prevents Terraform pre-expansion
cat >/etc/clickhouse-server/config.d/10-data-path.xml <<EOF
<clickhouse>
  <path>$${TARGET_PATH}/</path>
  <tmp_path>$${TARGET_PATH}/tmp/</tmp_path>
</clickhouse>
EOF

cat >/etc/clickhouse-server/config.d/20-network.xml <<EOF
<clickhouse>
  <listen_host>0.0.0.0</listen_host>
  <http_port>$${CH_HTTP}</http_port>
  <tcp_port>$${CH_TCP}</tcp_port>
</clickhouse>
EOF

# ---------------- Systemd region env (optional) ---------
mkdir -p /etc/systemd/system/clickhouse-server.service.d
cat >/etc/systemd/system/clickhouse-server.service.d/aws-env.conf <<EOF
[Service]
Environment=AWS_REGION=${AWS_REGION}
Environment=AWS_DEFAULT_REGION=${AWS_REGION}
EOF

# ---------------- Conditionally add S3 disk -------------
# Require ALL of: region, bucket, prefix
if [[ -n "${AWS_REGION}" && -n "${BACKUP_BUCKET}" && -n "${BACKUP_PREFIX}" ]]; then
  mkdir -p /var/lib/clickhouse/disks/s3_backups
  chown -R clickhouse:clickhouse /var/lib/clickhouse/disks

  # NOTE: $${...} so Terraform doesn't interpolate; bash will expand at runtime.
  cat >/etc/clickhouse-server/config.d/30-s3-backup.xml <<EOF
<clickhouse>
  <storage_configuration>
    <disks>
      <s3_backups>
        <!-- For BACKUP/RESTORE use s3_plain per docs -->
        <type>s3_plain</type>
        <!-- Bucket + prefix MUST be part of endpoint; trailing slash required -->
        <endpoint>https://$${BACKUP_BUCKET}.s3.$${AWS_REGION}.amazonaws.com/$${BACKUP_PREFIX}/</endpoint>
        <!-- Let CH fetch credentials from env & EC2/ECS metadata -->
        <use_environment_credentials>true</use_environment_credentials>
        <region>$${AWS_REGION}</region>
        <metadata_path>/var/lib/clickhouse/disks/s3_backups/</metadata_path>
      </s3_backups>
    </disks>
  </storage_configuration>

  <!-- Allow this disk to be used by BACKUP/RESTORE -->
  <backups>
    <allowed_disk>s3_backups</allowed_disk>
  </backups>
</clickhouse>
EOF
  chmod 0644 /etc/clickhouse-server/config.d/30-s3-backup.xml
else
  echo "[userdata] Skipping S3 disk: require AWS_REGION, BACKUP_BUCKET, BACKUP_PREFIX"
fi

# ---------------- Validate config & start ---------------

# Ensure data & log dirs exist with correct ownership
sudo mkdir -p /var/lib/clickhouse /var/log/clickhouse-server
sudo chown -R clickhouse:clickhouse /var/lib/clickhouse /var/log/clickhouse-server

# Some builds don’t ship a fully “installable” unit; ensure it has [Install]
if ! systemctl cat clickhouse-server | grep -q '^\[Install\]'; then
  cp -f /usr/lib/systemd/system/clickhouse-server.service /etc/systemd/system/clickhouse-server.service
  cat >>/etc/systemd/system/clickhouse-server.service <<'EOF'

[Install]
WantedBy=multi-user.target
EOF
else
  # Keep a copy under /etc/ so we can safely edit in future
  cp -f /usr/lib/systemd/system/clickhouse-server.service /etc/systemd/system/clickhouse-server.service || true
fi

systemctl daemon-reload

# Try the normal path first
if ! systemctl enable --now clickhouse-server 2>/tmp/ch-enable.err; then
  if grep -q 'systemd-sysv-install' /tmp/ch-enable.err; then
    # Fallback for images without SysV helper: manually create enable symlink
    mkdir -p /etc/systemd/system/multi-user.target.wants
    ln -sf /etc/systemd/system/clickhouse-server.service \
           /etc/systemd/system/multi-user.target.wants/clickhouse-server.service
    systemctl start clickhouse-server
  else
    echo "[userdata] systemctl enable failed:"
    cat /tmp/ch-enable.err
  fi
fi
rm -f /tmp/ch-enable.err || true

# Final sanity checks
if ! systemctl is-active --quiet clickhouse-server; then
  echo "[userdata] ERROR: clickhouse-server not active"
  journalctl -u clickhouse-server -n 200 --no-pager || true
  exit 1
fi

# Ports & quick query
ss -lntp | egrep '(:8123|:9000|:9009)' || true
clickhouse-client -q "SELECT version(), now()"

# ---------------- Backup script + timer -----------------
install -m 0755 -d /usr/local/bin
cat >/usr/local/bin/clickhouse-backup.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

TS="$(date -u +%Y%m%dT%H%M%SZ)"

# Use S3 disk if present; path is a subdir under the endpoint prefix
if [[ "$(clickhouse-client -q "SELECT count() FROM system.disks WHERE name='s3_backups'")" -eq 1 ]]; then
  clickhouse-client --multiquery -q "
    BACKUP DATABASE default TO Disk('s3_backups', 'auto-$${TS}/');
  "
  echo "Created ClickHouse BACKUP to Disk('s3_backups', 'auto-$${TS}/')"
else
  echo "s3_backups disk not configured; skipping (set AWS_REGION/BACKUP_BUCKET/BACKUP_PREFIX)"
  exit 0
fi
EOF
chmod +x /usr/local/bin/clickhouse-backup.sh

cat >/etc/systemd/system/clickhouse-backup.service <<'EOF'
[Unit]
Description=ClickHouse BACKUP DATABASE default -> S3 disk
After=network-online.target clickhouse-server.service
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/clickhouse-backup.sh
Nice=10
IOSchedulingClass=best-effort
IOSchedulingPriority=7
EOF

cat >/etc/systemd/system/clickhouse-backup.timer <<'EOF'
[Unit]
Description=Run ClickHouse Backup Daily

[Timer]
OnCalendar=daily
RandomizedDelaySec=10m
Persistent=true

[Install]
WantedBy=timers.target
EOF

systemctl daemon-reload
systemctl enable --now clickhouse-backup.timer
systemctl list-timers --all | grep clickhouse-backup || true

# ---------------- Marker -------------------------------
echo "$(date -u +%FT%TZ) BOOTSTRAP_OK" > "$MARKER_FILE"
echo "[userdata] done $(date -Is)"
