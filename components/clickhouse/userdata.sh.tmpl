#!/usr/bin/env bash
set -euxo pipefail
exec > >(tee -a /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1
echo "[userdata] start $(date -Is)"

# ---------------- Inputs from Terraform ----------------
EBS_DEV="${EBS_DEVICE}"                     # "" => auto-pick largest non-root NVMe
MNT="${MOUNT_POINT}"                        # e.g., "/var/lib/clickhouse"
MARKER_FILE="${MARKER_FILE}"                # e.g., "/var/local/BOOTSTRAP_OK"
CLICKHOUSE_HTTP="${CLICKHOUSE_HTTP_PORT}"   # e.g., 8123
CLICKHOUSE_TCP="${CLICKHOUSE_TCP_PORT}"     # e.g., 9000
BACKUP_BUCKET="${BACKUP_BUCKET}"            # e.g., "usekarma.dev-prod"
BACKUP_PREFIX="${BACKUP_PREFIX}"            # e.g., "clickhouse"
AWS_REGION="${AWS_REGION}"                  # e.g., "us-east-1"

# --- Remote scrape targets (filled by templatefile/TF) ---
MONGO_HOST="${MONGO_HOST}"                  # e.g. "10.0.1.10"
MONGO_EXP_PORT="${MONGO_EXP_PORT}"          # mongo exporter (percona) e.g. 9216
MONGO_NODE_PORT="${MONGO_NODE_PORT}"        # node_exporter on mongo host (9100)

REDPANDA_HOST="${REDPANDA_HOST}"            # e.g. "10.0.2.20"
REDPANDA_EXP_PORT="${REDPANDA_EXP_PORT}"    # redpanda admin metrics (9644)
REDPANDA_NODE_PORT="${REDPANDA_NODE_PORT}"  # node_exporter on redpanda host (9100)

# --- Versions passed from TF (do not default here) ---
PROMETHEUS_VER="${PROMETHEUS_VER}"          # e.g., 2.55.1
NODEEXP_VER="${NODEEXP_VER}"                # e.g., 1.8.2

# ---------------- Wait for basic network ----------------
for i in {1..30}; do curl -fsS https://aws.amazon.com >/dev/null && break || sleep 2; done

# ---------------- Detect package manager / distro -------
PM=""
if command -v dnf >/dev/null 2>&1; then
  PM="dnf" ; DISTRO="al2023"
elif command -v yum >/dev/null 2>&1; then
  PM="yum" ; DISTRO="al2"
elif command -v apt-get >/dev/null 2>&1; then
  PM="apt" ; DISTRO="ubuntu"
else
  echo "ERROR: No supported package manager found (dnf/yum/apt)" >&2
  exit 1
fi

# ---------------- Install & start SSM -------------------
if [[ "$PM" == "apt" ]]; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y
  apt-get install -y amazon-ssm-agent || true
else
  $PM -y update || true
  $PM -y install amazon-ssm-agent || true
fi
systemctl enable --now amazon-ssm-agent
systemctl is-active --quiet amazon-ssm-agent

# ---------------- Core tools ----------------------------
if [[ "$PM" == "apt" ]]; then
  apt-get install -y ca-certificates jq rsync xfsprogs xz-utils curl awscli zstd gnupg tar gzip netcat-openbsd
else
  $PM -y install ca-certificates jq rsync xfsprogs dnf-plugins-core awscli zstd gzip tar nmap-ncat --skip-broken || true
fi

# ---------------- Optional: pick & mount data disk -------
if [[ -n "$MNT" ]]; then
  mkdir -p "$MNT"

  pick_data_dev() {
    if [[ -n "$EBS_DEV" && -b "$EBS_DEV" ]]; then echo "$EBS_DEV"; return 0; fi
    local rootpk
    rootpk="$(lsblk -no pkname "$(findmnt -no SOURCE /)" 2>/dev/null | head -n1)"
    lsblk -dn -o NAME,TYPE,SIZE \
    | awk '$2=="disk"{print $1" "$3}' \
    | sort -k2 -hr | awk '{print $1}' \
      | while read -r n; do
          [[ "$n" == "$rootpk" ]] && continue
          [[ -b "/dev/$n" ]] && { echo "/dev/$n"; break; }
        done
  }

  DATA_DEV=""
  for _ in {1..60}; do
    DATA_DEV="$(pick_data_dev || true)"
    [[ -n "$DATA_DEV" && -b "$DATA_DEV" ]] && break
    sleep 2
  done

  if [[ -n "$DATA_DEV" ]]; then
    if ! blkid "$DATA_DEV" >/dev/null 2>&1; then
      if [[ "$PM" == "apt" ]]; then apt-get install -y xfsprogs; else $PM -y install xfsprogs || true; fi
      mkfs.xfs -f "$DATA_DEV"
    fi
    UUID="$(blkid -s UUID -o value "$DATA_DEV")"
    sed -i "\|[[:space:]]$MNT[[:space:]]|d;/^\/dev\/xvdb[[:space:]]/d" /etc/fstab
    grep -q "$UUID" /etc/fstab || echo "UUID=$UUID  $MNT  xfs  defaults,nofail  0  2" >> /etc/fstab
    mount -a
    mountpoint -q "$MNT"
  else
    echo "WARN: No data disk found; ClickHouse will use default /var/lib/clickhouse" >&2
  fi
fi

# ---------------- Install ClickHouse --------------------
if [[ "$PM" == "apt" ]]; then
  install -m 0755 -d /usr/share/keyrings
  curl -fsSL https://packages.clickhouse.com/apt/doc/apt-key.gpg \
    | gpg --dearmor -o /usr/share/keyrings/clickhouse.gpg
  echo "deb [signed-by=/usr/share/keyrings/clickhouse.gpg] https://packages.clickhouse.com/deb stable main" \
    > /etc/apt/sources.list.d/clickhouse.list
  apt-get update -y
  apt-get install -y clickhouse-server clickhouse-client
else
  dnf config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo || true
  $PM -y makecache || true
  $PM -y install clickhouse-server clickhouse-client
fi

# ---------------- Configure data path & ports -----------
systemctl stop clickhouse-server || true

TARGET_PATH="/var/lib/clickhouse"
if [[ -n "$MNT" && -n "$(mount | awk '{print $3}' | grep -Fx "$MNT" || true)" ]]; then
  TARGET_PATH="$MNT"
fi

mkdir -p "$TARGET_PATH" /var/lib/clickhouse
chown -R clickhouse:clickhouse "$TARGET_PATH"
rsync -a /var/lib/clickhouse/ "$TARGET_PATH"/ || true
chown -R clickhouse:clickhouse "$TARGET_PATH"

mkdir -p /etc/clickhouse-server/config.d

# (Terraform must not expand these)
cat >/etc/clickhouse-server/config.d/10-data-path.xml <<EOF
<clickhouse>
  <path>$${TARGET_PATH}/</path>
  <tmp_path>$${TARGET_PATH}/tmp/</tmp_path>
</clickhouse>
EOF

cat >/etc/clickhouse-server/config.d/20-network.xml <<EOF
<clickhouse>
  <listen_host>0.0.0.0</listen_host>
  <http_port>$${CLICKHOUSE_HTTP}</http_port>
  <tcp_port>$${CLICKHOUSE_TCP}</tcp_port>
</clickhouse>
EOF

# ---------------- Systemd region env (optional) ---------
mkdir -p /etc/systemd/system/clickhouse-server.service.d
cat >/etc/systemd/system/clickhouse-server.service.d/aws-env.conf <<EOF
[Service]
Environment=AWS_REGION=${AWS_REGION}
Environment=AWS_DEFAULT_REGION=${AWS_REGION}
EOF

# ---------------- Conditionally add S3 disk -------------
if [[ -n "${AWS_REGION}" && -n "${BACKUP_BUCKET}" && -n "${BACKUP_PREFIX}" ]]; then
  mkdir -p /var/lib/clickhouse/disks/s3_backups
  chown -R clickhouse:clickhouse /var/lib/clickhouse/disks
  cat >/etc/clickhouse-server/config.d/30-s3-backup.xml <<EOF
<clickhouse>
  <storage_configuration>
    <disks>
      <s3_backups>
        <type>s3_plain</type>
        <endpoint>https://$${BACKUP_BUCKET}.s3.$${AWS_REGION}.amazonaws.com/$${BACKUP_PREFIX}/</endpoint>
        <use_environment_credentials>true</use_environment_credentials>
        <region>$${AWS_REGION}</region>
        <metadata_path>/var/lib/clickhouse/disks/s3_backups/</metadata_path>
      </s3_backups>
    </disks>
  </storage_configuration>
  <backups><allowed_disk>s3_backups</allowed_disk></backups>
</clickhouse>
EOF
  chmod 0644 /etc/clickhouse-server/config.d/30-s3-backup.xml
else
  echo "[userdata] Skipping S3 disk: require AWS_REGION, BACKUP_BUCKET, BACKUP_PREFIX"
fi

# ---------------- Validate config & start ---------------
mkdir -p /var/lib/clickhouse /var/log/clickhouse-server
chown -R clickhouse:clickhouse /var/lib/clickhouse /var/log/clickhouse-server

if ! systemctl cat clickhouse-server | grep -q '^\[Install\]'; then
  cp -f /usr/lib/systemd/system/clickhouse-server.service /etc/systemd/system/clickhouse-server.service
  cat >>/etc/systemd/system/clickhouse-server.service <<'EOF'

[Install]
WantedBy=multi-user.target
EOF
else
  cp -f /usr/lib/systemd/system/clickhouse-server.service /etc/systemd/system/clickhouse-server.service || true
fi

systemctl daemon-reload

if ! systemctl enable --now clickhouse-server 2>/tmp/ch-enable.err; then
  if grep -q 'systemd-sysv-install' /tmp/ch-enable.err; then
    mkdir -p /etc/systemd/system/multi-user.target.wants
    ln -sf /etc/systemd/system/clickhouse-server.service \
           /etc/systemd/system/multi-user.target.wants/clickhouse-server.service
    systemctl start clickhouse-server
  else
    echo "[userdata] systemctl enable failed:"; cat /tmp/ch-enable.err
  fi
fi
rm -f /tmp/ch-enable.err || true

if ! systemctl is-active --quiet clickhouse-server; then
  echo "[userdata] ERROR: clickhouse-server not active"
  journalctl -u clickhouse-server -n 200 --no-pager || true
  exit 1
fi

ss -lntp | egrep '(:8123|:9000|:9009)' || true
clickhouse-client -q "SELECT version(), now()"

# ---------------- Backup script + timer -----------------
install -m 0755 -d /usr/local/bin
cat >/usr/local/bin/clickhouse-backup.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
TS="$(date -u +%Y%m%dT%H%M%SZ)"
if [[ "$(clickhouse-client -q "SELECT count() FROM system.disks WHERE name='s3_backups'")" -eq 1 ]]; then
  clickhouse-client --multiquery -q "
    BACKUP DATABASE default TO Disk('s3_backups', 'auto-$${TS}/');
  "
  echo "Created ClickHouse BACKUP to Disk('s3_backups', 'auto-$${TS}/')"
else
  echo "s3_backups disk not configured; skipping (set AWS_REGION/BACKUP_BUCKET/BACKUP_PREFIX)"
  exit 0
fi
EOF
chmod +x /usr/local/bin/clickhouse-backup.sh

cat >/etc/systemd/system/clickhouse-backup.service <<'EOF'
[Unit]
Description=ClickHouse BACKUP DATABASE default -> S3 disk
After=network-online.target clickhouse-server.service
Wants=network-online.target
[Service]
Type=oneshot
ExecStart=/usr/local/bin/clickhouse-backup.sh
Nice=10
IOSchedulingClass=best-effort
IOSchedulingPriority=7
EOF

cat >/etc/systemd/system/clickhouse-backup.timer <<'EOF'
[Unit]
Description=Run ClickHouse Backup Daily
[Timer]
OnCalendar=daily
RandomizedDelaySec=10m
Persistent=true
[Install]
WantedBy=timers.target
EOF

systemctl daemon-reload
systemctl enable --now clickhouse-backup.timer
systemctl list-timers --all | grep clickhouse-backup || true

# ================= Prometheus + Grafana + Exporters =================

# ---- Prometheus (binary install) ----
cd /opt
if [[ ! -d "/opt/prometheus-${PROMETHEUS_VER}.linux-amd64" ]]; then
  curl -fL -o /opt/prometheus.tgz \
    "https://github.com/prometheus/prometheus/releases/download/v${PROMETHEUS_VER}/prometheus-${PROMETHEUS_VER}.linux-amd64.tar.gz"
  tar xzf /opt/prometheus.tgz
  rm -f /opt/prometheus.tgz
fi
ln -sf "/opt/prometheus-${PROMETHEUS_VER}.linux-amd64" /opt/prometheus

# System user
if ! id -u prometheus >/dev/null 2>&1; then
  if [[ "$PM" == "apt" ]]; then
    useradd --system --no-create-home --shell /usr/sbin/nologin prometheus || true
  else
    useradd --system --no-create-home --shell /sbin/nologin prometheus || true
  fi
fi

install -d -o prometheus -g prometheus /var/lib/prometheus /etc/prometheus

cat >/etc/prometheus/prometheus.yml <<'YAML'
global:
  scrape_interval: 15s

scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['127.0.0.1:9090']

  # Local node_exporter (this Prom box)
  - job_name: 'node-local'
    static_configs:
      - targets: ['127.0.0.1:9100']
        labels: { role: 'prom-box' }

  # Remote node_exporters (Mongo & Redpanda boxes)
  - job_name: 'node-remote'
    static_configs:
      - targets:
          - "${MONGO_HOST}:${MONGO_NODE_PORT}"
          - "${REDPANDA_HOST}:${REDPANDA_NODE_PORT}"
        labels: { role: 'remote-node' }

  # ClickHouse native metrics on this host
  - job_name: 'clickhouse'
    metrics_path: /metrics
    static_configs:
      - targets: ['127.0.0.1:9363']

  # MongoDB exporter (on Mongo box)
  - job_name: 'mongo'
    metrics_path: /metrics
    static_configs:
      - targets:
          - "${MONGO_HOST}:${MONGO_EXP_PORT}"
        labels: { service: 'mongodb' }

  # Redpanda admin/metrics (on Redpanda box)
  - job_name: 'redpanda'
    metrics_path: /metrics
    static_configs:
      - targets:
          - "${REDPANDA_HOST}:${REDPANDA_EXP_PORT}"
        labels: { service: 'redpanda-admin' }

  # Kafka Connect
  - job_name: 'kconnect'
    metrics_path: /metrics
    static_configs:
      - targets:
          - 'kconnect-metrics.internal:9404'
        labels: { service: 'kconnect' }

YAML

cat >/etc/systemd/system/prometheus.service <<'EOF'
[Unit]
Description=Prometheus
After=network-online.target
Wants=network-online.target
[Service]
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus \
  --web.listen-address=0.0.0.0:9090
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF

chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
systemctl daemon-reload
systemctl enable --now prometheus

# ---- Grafana (repo install) ----
if [[ "$PM" == "apt" ]]; then
  install -m 0755 -d /usr/share/keyrings
  curl -fsSL https://packages.grafana.com/gpg.key | gpg --dearmor -o /usr/share/keyrings/grafana.gpg
  echo "deb [signed-by=/usr/share/keyrings/grafana.gpg] https://packages.grafana.com/oss/deb stable main" \
    > /etc/apt/sources.list.d/grafana.list
  apt-get update -y
  apt-get install -y grafana
else
  if [[ ! -f /etc/yum.repos.d/grafana.repo ]]; then
    cat >/etc/yum.repos.d/grafana.repo <<'REPO'
[grafana]
name=Grafana OSS
baseurl=https://packages.grafana.com/oss/rpm
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://packages.grafana.com/gpg.key
REPO
  fi
  $PM -y makecache || true
  $PM -y install grafana
fi
systemctl enable --now grafana-server


# ---- Node Exporter (binary install; loopback only) ----
cd /opt
if [[ ! -d "/opt/node_exporter-${NODEEXP_VER}.linux-amd64" ]]; then
  curl -fL -o /opt/node_exporter.tgz \
    "https://github.com/prometheus/node_exporter/releases/download/v${NODEEXP_VER}/node_exporter-${NODEEXP_VER}.linux-amd64.tar.gz"
  tar xzf /opt/node_exporter.tgz
  rm -f /opt/node_exporter.tgz
fi
ln -sf "/opt/node_exporter-${NODEEXP_VER}.linux-amd64" /opt/node_exporter

if ! id -u nodeexp >/dev/null 2>&1; then
  if [[ "$PM" == "apt" ]]; then
    useradd --system --no-create-home --shell /usr/sbin/nologin nodeexp || true
  else
    useradd --system --no-create-home --shell /sbin/nologin nodeexp || true
  fi
fi

cat >/etc/systemd/system/node_exporter.service <<'EOF'
[Unit]
Description=Prometheus Node Exporter
After=network-online.target
Wants=network-online.target
[Service]
User=nodeexp
Group=nodeexp
ExecStart=/opt/node_exporter/node_exporter --web.listen-address=127.0.0.1:9100
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now node_exporter

# ---- ClickHouse native Prometheus endpoint on 9363 ----
cat >/etc/clickhouse-server/config.d/40-prometheus.xml <<'EOF'
<clickhouse>
  <prometheus>
    <endpoint>/metrics</endpoint>
    <port>9363</port>
    <metrics>true</metrics>
    <events>true</events>
    <asynchronous_metrics>true</asynchronous_metrics>
  </prometheus>
</clickhouse>
EOF

systemctl restart clickhouse-server || true

# ---- Quick logs / ports ----
ss -lntp | egrep '(:9090|:3000|:9100|:9363)' || true
echo "[userdata:obs] Prometheus=9090 Grafana=3000 NodeExp=9100 CH-metrics=9363 configured"

# Non-fatal reachability checks (these may fail until SGs are correct)
curl -fsS "http://${MONGO_HOST}:${MONGO_EXP_PORT}/metrics" | head -n 3 || true
curl -fsS "http://${REDPANDA_HOST}:${REDPANDA_EXP_PORT}/metrics" | head -n 3 || true
curl -fsS "http://${MONGO_HOST}:${MONGO_NODE_PORT}/metrics" | head -n 3 || true
curl -fsS "http://${REDPANDA_HOST}:${REDPANDA_NODE_PORT}/metrics" | head -n 3 || true

# ---------------- Marker -------------------------------
echo "$(date -u +%FT%TZ) BOOTSTRAP_OK" > "$MARKER_FILE"
echo "[userdata] done $(date -Is)"
